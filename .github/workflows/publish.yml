name: Publish

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write  # IMPORTANT: this permission is mandatory for trusted publishing

    steps:
    - name: Checkout
      uses: actions/checkout@v6.0.2
      with:
        fetch-depth: 0

    - name: Check if this is a release commit
      run: |
        COMMIT_MSG=$(git log --oneline -1 --pretty=%B)
        if [[ "$COMMIT_MSG" == *chore\(release\)* ]]; then
          echo "This is a release commit: $COMMIT_MSG"
          echo "is_release=true" >> $GITHUB_OUTPUT
        else
          echo "This is not a release commit: $COMMIT_MSG"
          echo "is_release=false" >> $GITHUB_OUTPUT
        fi
      id: check-release

    - name: Extract version from commit
      id: extract-version
      run: |
        # Extract version from commit message like "chore(release): 1.3.0"
        VERSION=$(echo "${{ github.event.head_commit.message }}" | sed -n 's/chore(release): \([0-9]\+\.[0-9]\+\.[0-9]\+\)/\1/p')
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Build package
      run: |
        python -m pip install --upgrade pip
        pip install build
        python -m build

    - name: Generate release notes
      id: release-notes
      run: |
        # Generate release notes from changelog or recent commits
        if [ -f CHANGELOG.md ]; then
          # Try to extract version-specific notes from changelog
          NOTES=$(sed -n "/## ${{ steps.extract-version.outputs.version }}/,/^## /p" CHANGELOG.md | head -n -1)
          if [ -z "$NOTES" ]; then
            # Fallback to recent changelog entries
            NOTES=$(head -30 CHANGELOG.md)
          fi
        else
          # Fallback to recent commit messages
          NOTES=$(git log --oneline -10 --grep="feat:\|fix:\|docs:\|chore:" | head -10)
        fi

        # Escape newlines for GitHub API
        NOTES_ESCAPED=$(echo "$NOTES" | sed ':a;N;$!ba;s/\n/\\n/g')
        echo "notes=$NOTES_ESCAPED" >> $GITHUB_OUTPUT

    - name: Create GitHub release
      id: create-release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "Creating GitHub release v${{ steps.extract-version.outputs.version }}..."

        # Create the release with generated notes
        gh release create v${{ steps.extract-version.outputs.version }} \
          --title "Release v${{ steps.extract-version.outputs.version }}" \
          --notes "${{ steps.release-notes.outputs.notes }}"

        echo "✅ GitHub release created successfully"

    - name: Publish to PyPI
      id: pypi-publish
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        print-hash: true
      continue-on-error: true

    - name: Handle PyPI publish result
      if: always() && steps.pypi-publish.outcome == 'failure'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "❌ PyPI publish failed. Adding warning to GitHub release..."

        # Create updated release notes with warning
        UPDATED_NOTES="${{ steps.release-notes.outputs.notes }}

        ---
        ⚠️ **Warning**: PyPI publication failed for this release. The package may not be available for installation via pip. Please check the workflow logs and retry the publication manually if needed."

        # Edit the release to add the warning
        echo "$UPDATED_NOTES" | gh release edit v${{ steps.extract-version.outputs.version }} \
          --notes-file -

        echo "✅ Warning added to GitHub release"

    - name: Verify PyPI publication
      if: steps.pypi-publish.outcome == 'success'
      run: |
        echo "✅ PyPI publish completed. Verifying package availability..."

        # Wait a moment for PyPI to process the upload
        sleep 10

        # Check if the package is available on PyPI
        if curl -s "https://pypi.org/pypi/subscriptions-to-csv/${{ steps.extract-version.outputs.version }}/json" > /dev/null; then
          echo "✅ Package verified on PyPI"
          echo "Release v${{ steps.extract-version.outputs.version }} is now available on both GitHub and PyPI"
        else
          echo "⚠️ Package upload reported success but verification failed. This may be due to PyPI processing delays."
          echo "Please manually verify at: https://pypi.org/project/subscriptions-to-csv/${{ steps.extract-version.outputs.version }}/"
        fi