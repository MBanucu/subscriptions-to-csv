name: Release

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  release:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && contains(github.event.head_commit.message, 'chore(release):')) }}
    runs-on: ubuntu-latest
    outputs:
      release_branch: ${{ steps.create-branch.outputs.branch_name }}
      new_release: ${{ steps.semantic.outputs.new_release_published }}
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write  # IMPORTANT: this permission is mandatory for trusted publishing

    steps:
    - name: Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 0  # Important for semantic-release to analyze all commits

    - name: Semantic Release (Dry Run)
      uses: cycjimmy/semantic-release-action@v6
      id: semantic
      with:
        semantic_version: 25.0.2
        dry_run: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create release branch (if release needed)
      id: create-branch
      if: steps.semantic.outputs.new_release_published == 'true'
      run: |
        BRANCH_NAME="release/v${{ steps.semantic.outputs.new_release_version }}"
        git checkout -b "$BRANCH_NAME"
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

    - name: Update version files (if release branch created)
      if: steps.create-branch.outputs.branch_name != ''
      run: |
        # Update version in pyproject.toml
        sed -i "s/version = \".*\"/version = \"${{ steps.semantic.outputs.new_release_version }}\"/" pyproject.toml
        # Update version in __init__.py
        sed -i "s/__version__ = \".*\"/__version__ = \"${{ steps.semantic.outputs.new_release_version }}\"/" subscriptions_to_csv/__init__.py
        # Update version in flake.nix
        sed -i "s/version = \".*\";/version = \"${{ steps.semantic.outputs.new_release_version }}\";/" flake.nix

    - name: Update changelog (if release branch created)
      if: steps.create-branch.outputs.branch_name != ''
      run: |
        # Generate changelog using semantic-release dry run results
        echo "# Changelog" > temp_changelog.md
        echo "" >> temp_changelog.md
        echo "## ${{ steps.semantic.outputs.new_release_version }} ($(date +%Y-%m-%d))" >> temp_changelog.md
        echo "" >> temp_changelog.md
        # Add release notes from semantic release
        if [ -n "${{ steps.semantic.outputs.new_release_notes }}" ]; then
          echo "${{ steps.semantic.outputs.new_release_notes }}" >> temp_changelog.md
        fi
        echo "" >> temp_changelog.md

        # Prepend to existing CHANGELOG.md
        if [ -f CHANGELOG.md ]; then
          cat CHANGELOG.md >> temp_changelog.md
        fi
        mv temp_changelog.md CHANGELOG.md

    - name: Commit changes (if release branch created)
      if: steps.create-branch.outputs.branch_name != ''
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add pyproject.toml subscriptions_to_csv/__init__.py flake.nix CHANGELOG.md
        git commit -m "chore(release): ${{ steps.semantic.outputs.new_release_version }}"

    - name: Push release branch (if created)
      if: steps.create-branch.outputs.branch_name != ''
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        git push --force origin "${{ steps.create-branch.outputs.branch_name }}"

    - name: Check if PR already exists (if release branch created)
      id: check-pr
      if: steps.create-branch.outputs.branch_name != ''
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        BRANCH="${{ steps.create-branch.outputs.branch_name }}"
        EXISTING_PR=$(gh pr list --head "$BRANCH" --json number --jq 'length')
        echo "pr_exists=$EXISTING_PR" >> $GITHUB_OUTPUT
        if [ "$EXISTING_PR" -gt 0 ]; then
          PR_NUMBER=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number')
          echo "existing_pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        fi

    - name: Close existing PR (if PR exists)
      if: steps.check-pr.outputs.pr_exists != '0'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        PR_NUMBER=${{ steps.check-pr.outputs.existing_pr_number }}
        echo "Closing existing PR #$PR_NUMBER to ensure fresh CI triggering..."
        gh pr close $PR_NUMBER --comment "Closed to create fresh PR with proper CI triggering"

    - name: Create pull request (always create fresh PR)
      id: create-pr
      if: steps.create-branch.outputs.branch_name != ''
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
         TITLE="chore(release): ${{ steps.semantic.outputs.new_release_version }}"
         BODY="Automated release ${{ steps.semantic.outputs.new_release_version }}

         ## Changes
         ${{ steps.semantic.outputs.new_release_notes }}

         ---
         ðŸ¤– This PR was automatically created by the release workflow."

          # Create the PR
          echo "$BODY" | gh pr create \
            --title "$TITLE" \
            --body-file - \
            --base main \
            --head "${{ steps.create-branch.outputs.branch_name }}"

    - name: Auto-merge enabled
      if: steps.create-branch.outputs.branch_name != ''
      run: |
        echo "âœ… Release PR created successfully"
        echo "ðŸ¤– Auto-merge is enabled at the repository level"

