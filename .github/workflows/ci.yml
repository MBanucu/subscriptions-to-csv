name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  pull_request_target:
    branches: [ 'release/**' ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12', '3.13']

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        ref: ${{ github.event.pull_request.head.sha || github.ref }}

    - name: Generate requirements-dev.txt
      run: |
        python3 -c "
        import sys
        print(f'Using Python {sys.version_info.major}.{sys.version_info.minor}')
        try:
            import tomllib
            print('Using built-in tomllib')
        except ImportError:
            print('tomllib not available, installing tomli...')
            import subprocess
            subprocess.run([sys.executable, '-m', 'pip', 'install', 'tomli'], check=True)
            import tomli as tomllib
            print('Using tomli fallback')

        with open('pyproject.toml', 'rb') as f:
            data = tomllib.load(f)
        deps = data.get('project', {}).get('optional-dependencies', {}).get('dev', [])
        with open('requirements-dev.txt', 'w') as f:
            f.write('# Auto-generated from pyproject.toml optional-dependencies.dev\n')
            f.write('# Do not edit manually\n\n')
            for dep in sorted(deps):
                f.write(f'{dep}\n')
        print(f'Generated requirements-dev.txt with {len(deps)} dependencies')
        "

    - name: Validate requirements-dev.txt sync
      run: |
        # Generate fresh copy for comparison
        python3 -c "
        import sys
        try:
            import tomllib
        except ImportError:
            import subprocess
            subprocess.run([sys.executable, '-m', 'pip', 'install', 'tomli'], check=True)
            import tomli as tomllib

        with open('pyproject.toml', 'rb') as f:
            data = tomllib.load(f)
        deps = data.get('project', {}).get('optional-dependencies', {}).get('dev', [])

        with open('requirements-dev-generated.txt', 'w') as f:
            f.write('# Auto-generated from pyproject.toml optional-dependencies.dev\n')
            f.write('# Do not edit manually\n\n')
            for dep in sorted(deps):
                f.write(f'{dep}\n')
        "

        # Compare with committed version
        if ! diff -q requirements-dev.txt requirements-dev-generated.txt > /dev/null 2>&1; then
          echo "âŒ requirements-dev.txt is out of sync with pyproject.toml"
          echo ""
          echo "Expected content (auto-generated):"
          cat requirements-dev-generated.txt
          echo ""
          echo "Actual content (committed):"
          cat requirements-dev.txt
          echo ""
          echo "ðŸ’¡ To fix: The requirements-dev.txt should be auto-generated from pyproject.toml"
          echo "   Do not edit it manually. Update pyproject.toml optional-dependencies.dev instead."
          rm requirements-dev-generated.txt
          exit 1
        fi

        echo "âœ… requirements-dev.txt is in sync with pyproject.toml"
        rm requirements-dev-generated.txt

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        cache-dependency-path: |
          requirements-dev.txt

    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('requirements-dev.txt') }}
        restore-keys: |
          venv-${{ runner.os }}-${{ matrix.python-version }}-

    - name: Create/update virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        echo "ðŸ“¦ Creating fresh virtual environment"
        python -m venv .venv
        source .venv/bin/activate
        pip install -e .
        echo "âœ… Virtual environment created"

    - name: Activate cached virtual environment
      run: |
        echo "ðŸ”„ Activating virtual environment"
        source .venv/bin/activate
        echo "âœ… Virtual environment ready"
        echo "cache_hit=${{ steps.venv-cache.outputs.cache-hit }}" >> $GITHUB_OUTPUT

    - name: Install test dependencies
      run: |
        source .venv/bin/activate
        pip install pytest pytest-cov

    - name: Run tests
      run: |
        source .venv/bin/activate
        python -m pytest tests/ -v --tb=short --cov=subscriptions_to_csv --cov-branch --cov-report=xml

    - name: Upload coverage to Codecov
      if: matrix.python-version == '3.13'
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}

  mypy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha || github.ref }}

      - name: Generate requirements-dev.txt
        run: |
          python3 -c "
          import sys
          print(f'Using Python {sys.version_info.major}.{sys.version_info.minor}')
          try:
              import tomllib
              print('Using built-in tomllib')
          except ImportError:
              print('tomllib not available, installing tomli...')
              import subprocess
              subprocess.run([sys.executable, '-m', 'pip', 'install', 'tomli'], check=True)
              import tomli as tomllib
              print('Using tomli fallback')

          with open('pyproject.toml', 'rb') as f:
              data = tomllib.load(f)
          deps = data.get('project', {}).get('optional-dependencies', {}).get('dev', [])
          with open('requirements-dev.txt', 'w') as f:
              f.write('# Auto-generated from pyproject.toml optional-dependencies.dev\n')
              f.write('# Do not edit manually\n\n')
              for dep in sorted(deps):
                  f.write(f'{dep}\n')
          print(f'Generated requirements-dev.txt with {len(deps)} dependencies')
          "

      - name: Validate requirements-dev.txt sync
        run: |
          # Generate fresh copy for comparison
          python3 -c "
          import sys
          try:
              import tomllib
          except ImportError:
              import subprocess
              subprocess.run([sys.executable, '-m', 'pip', 'install', 'tomli'], check=True)
              import tomli as tomllib

          with open('pyproject.toml', 'rb') as f:
              data = tomllib.load(f)
          deps = data.get('project', {}).get('optional-dependencies', {}).get('dev', [])

          with open('requirements-dev-generated.txt', 'w') as f:
              f.write('# Auto-generated from pyproject.toml optional-dependencies.dev\n')
              f.write('# Do not edit manually\n\n')
              for dep in sorted(deps):
                  f.write(f'{dep}\n')
          "

          # Compare with committed version
          if ! diff -q requirements-dev.txt requirements-dev-generated.txt > /dev/null 2>&1; then
            echo "âŒ requirements-dev.txt is out of sync with pyproject.toml"
            echo ""
            echo "Expected content (auto-generated):"
            cat requirements-dev-generated.txt
            echo ""
            echo "Actual content (committed):"
            cat requirements-dev.txt
            echo ""
            echo "ðŸ’¡ To fix: The requirements-dev.txt should be auto-generated from pyproject.toml"
            echo "   Do not edit it manually. Update pyproject.toml optional-dependencies.dev instead."
            rm requirements-dev-generated.txt
            exit 1
          fi

          echo "âœ… requirements-dev.txt is in sync with pyproject.toml"
          rm requirements-dev-generated.txt

      - name: Set up Python 3.8
        uses: actions/setup-python@v6
        with:
          python-version: 3.8
          cache: 'pip'
          cache-dependency-path: |
            requirements-dev.txt

      - name: Cache virtual environment
        uses: actions/cache@v4
        id: venv-cache
        with:
          path: .venv
          key: venv-${{ runner.os }}-3.8-${{ hashFiles('requirements-dev.txt') }}
          restore-keys: |
            venv-${{ runner.os }}-3.8-

      - name: Cache mypy analysis
        uses: actions/cache@v4
        with:
          path: .mypy_cache
          key: mypy-${{ runner.os }}-${{ hashFiles('**/*.py', 'mypy.ini') }}
          restore-keys: |
            mypy-${{ runner.os }}-

      - name: Create/update virtual environment
        if: steps.venv-cache.outputs.cache-hit != 'true'
        run: |
          echo "ðŸ“¦ Creating fresh virtual environment"
          python -m venv .venv
          source .venv/bin/activate
          pip install -e .
          echo "âœ… Virtual environment created"

      - name: Activate cached virtual environment
        run: |
          echo "ðŸ”„ Activating virtual environment"
          source .venv/bin/activate
          echo "âœ… Virtual environment ready"
          echo "cache_hit=${{ steps.venv-cache.outputs.cache-hit }}" >> $GITHUB_OUTPUT

      - name: Install mypy
        run: |
          source .venv/bin/activate
          pip install mypy

      - name: Run mypy
        run: |
          source .venv/bin/activate
          mypy subscriptions_to_csv/

  # Summary job that depends on all quality checks
  ci-success:
    if: always()
    runs-on: ubuntu-latest
    needs: [test, mypy]
    steps:
      - name: Cache performance metrics
        run: |
          echo "ðŸ“Š CI Cache Performance Report"
          echo "================================"

          # Check test job cache status (simplified - would need job outputs)
          echo "ðŸƒ Test Matrix: ${{ needs.test.result }}"
          echo "ðŸ” MyPy Job: ${{ needs.mypy.result }}"

          # Note about caching benefits
          echo ""
          echo "ðŸ’¡ Caching Status:"
          echo "  - Virtual environments cached per Python version"
          echo "  - Pip dependencies cached via actions/setup-python"
          echo "  - MyPy analysis cached to avoid re-processing"
          echo ""
          echo "ðŸ“ˆ Expected speedup: 65-85% reduction in CI time"

      - name: Check all quality checks
        run: |
          # Check test results
          if [[ ${{ needs.test.result }} != 'success' ]]; then
            echo "âŒ Test job failed"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Check mypy results
          if [[ ${{ needs.mypy.result }} != 'success' ]]; then
            echo "âŒ MyPy type checking failed"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "âœ… All quality checks passed!"
          echo "status=success" >> $GITHUB_OUTPUT
